<!DOCTYPE html>
<html lang="fr">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Windows Credential Guard et Mimikatz | crowd42's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    


    <link rel="shortcut icon" href="/images/favicon.ico">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">crowd42's blog</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">7</span>] = <span class="string">"crowd42"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/crowd42" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>

    <p>
    printf(<a href="https://mastodon.social/crowd42"
      target="_blank"><span class="string">"https://mastodon.social/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>

    <p>
    printf(<a href="https://keybase.io/crowd42"
      target="_blank"><span class="string">"https://keybase.io/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>


     <p>
    printf(<a href="https://twitter.com/crowd42"
      target="_blank"><span class="string">"https://twitter.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>

    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>riseup<span class="reserved">\x2e\\\b</span>net<span class="reserved">\n</span>"</span>,nick);
    </p>
    <!-- <p>
            printf(<a href="https://crowd42.github.io" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.github.io<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="misc/pubkey.gpg.txt" target="_blank"><span
        class="string">"0xdc 5a6d b445 976d 60"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/blog/">blog</a></li>
          <li> <a href="/astuces/">astuces</a></li>
          <li><a href="/books/">books</a></li>
          <li><a href="/casts">*casts</a></li>
          <li><a href="/movies">movies</a></li>
          <li><a href="/talks">talks</a></li>
          <li><a href="/zines">*zines</a></li>
          <li><a href="/ressources">ressources</a></li>
          <li><a href="/feed">feed</a></li>
          <li><a href="https://liberapay.com/~29921/donate">donate</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>Windows Credential Guard et Mimikatz</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Jan 11, 2018
        
        
        •
        <span><a href="/category/#infosec" class="reserved">infosec</a>,</span><span><a href="/category/#mimikatz" class="reserved">mimikatz</a>,</span><span><a href="/category/#windows" class="reserved">windows</a>,</span><span><a href="/category/#windows credential guard" class="reserved">windows credential guard</a>,</span><span><a href="/category/#pentest" class="reserved">pentest</a></span>
    </p>
  </header>

  <article class="post-content">
  <p>Demandez à n’importe quel penetration tester son top 10 des outils dont il ne peut pas s’en passer et vous aurez de fortes chances de voir <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz [0]</a> figurez dans le haut de son classement. C’est un outil extrêmement qui permet entre autres l’extraction des mots de passe d’un système d’exploitation Windows, de récupérer les mots de passe en clair ou l’injection des bibliothèques, les certificats ainsi que leurs clés privées, etc.</p>

<p>Afin de mitiger les risques que posent ce genre de logiciels, Microsoft a introduit une nouvelle fonctionnalité dans Windows 10 et Windows Server 2016 : <a href="https://docs.microsoft.com/en-us/windows/access-protection/credential-guard/credential-guard">Credential Guard [1]</a>. Cette fonctionnalité permet de stocker les secrets dans un environnement protégé et isolé, inaccessible pour l’utilisateur normal.</p>

<p>Credential Guard s’appuie sur la technologie <a href="http://woshub.com/virtual-secure-mode-vsm-in-windows-10-enterprise/">Virtual Secure Mode [\2]</a> (Sécurité basée sur la virtualisation). Cette dernière se base sur les fonctionnalités de virtualisation qu’offrent les nouveaux CPU. La combinaison des deux permet d’offrir un espace mémoire isolé pour stocké les secrets et qui ne sont pas accessibles au reste du système d’exploitation, en d’autres mots, l’espace mémoire isolé est protégé contre les tentatives de lecture et écriture de la part des autres processus de l’espace mémoire normal utilisé par le système d’exploitation. Pour mieux comprendre comment fonctionne Credential Guard <a href="https://blogs.technet.microsoft.com/ash/2016/03/02/windows-10-device-guard-and-credential-guard-demystified/">je vous invite à lire cet article [3]</a>.</p>
<iframe src="https://mva.microsoft.com/en-US/training-courses-embed/deep-dive-into-credential-guard-16651/Video-Credential-Theft-Lateral-Traversal-cfGBPlIyC_9404300474" width="636" height="480" allowfullscreen="" frameborder="0"></iframe>

<p>Credential Guard est un excellent moyen de se défendre contre des outils comme Mimikatz qui permettent d’extraire les hashs pour exécuter des attaques de type <a href="https://en.wikipedia.org/wiki/Pass_the_hash">pass the hash [4]</a>, tant que l’attaquant ne dispose des droits administrateurs (<a href="https://crowd42.github.io/comment-jai-pu-gagner-acces-administrateur-serveur-windows-grace-google/">des droits qu’on peut obtenir plus facilement que vous pouviez l’imaginer [5]</a>).</p>

<p>Un des moyens par lesquels Windows gère le processus d’authentification des utilisateurs est <a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface">Architecture de l’interface du fournisseur (Security Support Provider) SSP [6]</a>, par défaut Windows embarque de nombreux modules (NTLM, Kerberos…), mais il est possible d’installer ses propres modules SSP.</p>

<p>Et c’est là que (r)entre en action Mimikatz. En effet ce dernier a dans son arsenal un module SSP (memssp) qui une fois exécuté va être appelé à chaque fois un utilisateur va ouvrir une session et il sauvegardera les identifiants et les mots de passe dans un fichier (<code class="language-plaintext highlighter-rouge">C:\Windows\System32\mimilsa.log</code>).</p>

<p>D’abord il faut exécuter mimikatz avec en tant qu’administrateur, ensuite il faut activer le mode <code class="language-plaintext highlighter-rouge">debug privilege </code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz # privilege::debug
Privilege 20 'ok'
</code></pre></div></div>

<div>
	<img src="/images/posts/2018/mimikatz_debug.png" style="width:75%;" />
</div>
<p><br /></p>

<p>Puis on injecte le module memssp avec cette commande :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz # misc::memssp
Injected =&gt;
</code></pre></div></div>

<p>Maintenant préparez vous un café et attendez que des utilisateurs se connectent à la machine, dès qu’un deux va le faire, Mimikatz va intercepter son mot de passe et va l’enregistrer dans le fichier mimilsa.log, vous pouvez consulter ce fichier en l’éditant avec notepad ou en tapant la commande suivante :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:\Windows\System32&gt; type .\mimilsa.log
</code></pre></div></div>
<div>
	<img src="/images/posts/2018/mimikatz_ssp.png" style="width:85%;" />
</div>
<p><br />
Sympa non ? C’est à la fois une des limites de Credential Guard et points forts de Mimikatz et explique pourquoi cet outil est si populaire parmi les pentester :-).</p>

<div>
	<img src="/images/posts/2018/34134313-2658eb0e-e45a-11e7-9ded-0229b6da174a.gif" style="width:85%;" />
</div>
<p><br /></p>

<h3 id="liens">Liens</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0]: https://github.com/gentilkiwi/mimikatz
[1]: https://docs.microsoft.com/en-us/windows/access-protection/credential-guard/credential-guard
[2]: http://woshub.com/virtual-secure-mode-vsm-in-windows-10-enterprise/
[3]: https://blogs.technet.microsoft.com/ash/2016/03/02/windows-10-device-guard-and-credential-guard-demystified/
[4]: https://en.wikipedia.org/wiki/Pass_the_hash
[5]: https://crowd42.github.io/comment-jai-pu-gagner-acces-administrateur-serveur-windows-grace-google/
[6]:https://en.wikipedia.org/wiki/Security_Support_Provider_Interface
</code></pre></div></div>

  </article>
   

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
                
                <h1>Sur le même sujet</h1>
                <ul>
                
                <li>
                    <a href="http://localhost:4000/blog/microsoft-mots-de-passe-toute-une-histoire/">Microsoft et les mots de passe, toute une histoire
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <li>
                    <a href="http://localhost:4000/-blog/script-python-sites-web-meme-adresse-ip/">Un petit script pour récupérer les URLs des sites web hébergés sur la même adresse IP
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <li>
                    <a href="http://localhost:4000/blog/meltdown-spectre/">Deux points qui me tracassent à propos de meltdown et spectre
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <li>
                    <a href="http://localhost:4000/blog/full-disclosure-etihad-airways/">Full Disclosure : Des emails et mots de passe de la compagnie aérienne Etihad Airways dans l'air
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
                
                <li>
                    <a href="http://localhost:4000/comment-jai-pu-gagner-acces-administrateur-serveur-windows-grace-google/">Comment j'ai pu gagner un accès administrateur sur un serveur Windows 2012 grâce à Google
                    
                    </a>
                </li>
                
                
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
                
                <li>
                    <a href="http://localhost:4000/blog/gg-microsft/">GG Microsft !
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
    


    </ul>


	<p class="feed-recomendation">
		Si vous avez aimé ce billet, vous pouvez vous inscrire au <a href="feed/">flux RSS</a> !
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'crowd42s-blog-1';
    var disqus_config = function () {
        this.page.identifier = "/blog/windows-credential-guard-mimikatz/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Propulsé fièrement par Jekyll!
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
